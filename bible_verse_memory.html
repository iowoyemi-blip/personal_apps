<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verse Memorizer - Multi-Level</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .blank-input {
            width: 100px; /* Made slightly narrower for mobile */
            border: none;
            border-bottom: 2px solid #94a3b8; /* slate-400 */
            background-color: transparent;
            text-align: center;
            font-weight: 500;
            border-radius: 0;
            padding: 4px 2px;
            margin: 0 4px;
            transition: all 0.2s ease-in-out;
        }
        .blank-input:focus {
            outline: none;
            border-bottom-color: #3b82f6; /* blue-500 */
        }
        .correct {
            background-color: #dcfce7 !important; /* green-100 */
            border-bottom-color: #22c55e !important; /* green-500 */
        }
        .incorrect {
            background-color: #fee2e2 !important; /* red-100 */
            border-bottom-color: #ef4444 !important; /* red-500 */
        }
        /* Custom scrollbar for history if needed */
        .history-item {
            transition: all 0.2s;
        }
        .history-item:hover {
            transform: translateX(4px);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl mx-auto bg-white p-4 sm:p-6 md:p-8 rounded-2xl shadow-lg">

        <div id="setup-screen">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-slate-700 mb-2">Verse Memorizer</h1>
            <p class="text-center text-slate-500 mb-6">Paste your verse below to begin the challenge.</p>
            
            <textarea id="verse-input" rows="4" class="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="For God so loved the world, that he gave his only Son, that whoever believes in him should not perish but have eternal life."></textarea>
            
            <div id="setup-message-area" class="mt-4 text-center font-medium h-6 text-red-600"></div>

            <button id="start-btn" class="w-full mt-2 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105">
                Start Challenge
            </button>

            <!-- New History Section -->
            <div id="history-container" class="mt-8 pt-6 border-t border-slate-100 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Recent Verses</h3>
                    <button id="clear-history-btn" class="text-xs text-red-400 hover:text-red-600 font-medium">Clear History</button>
                </div>
                <div id="history-list" class="flex flex-col gap-2">
                    <!-- History items will be injected here -->
                </div>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div id="level-display" class="text-center text-lg font-bold text-blue-600 mb-2"></div>
            <h2 class="text-xl md:text-2xl font-bold text-slate-700 mb-2 text-center">Fill in the Blanks</h2>
            <p class="text-slate-500 mb-6 text-center">Type the missing words into the blank spaces below.</p>

            <div id="verse-display" class="p-4 border border-slate-200 rounded-lg min-h-[120px] flex flex-wrap gap-x-1 gap-y-4 items-center text-lg md:text-xl leading-loose">
                <!-- Verse with blanks will be injected here -->
            </div>

            <div id="message-area" class="mt-4 text-center font-medium h-6"></div>

            <div class="flex flex-col sm:flex-row gap-3 mt-6">
                <button id="check-btn" class="w-full sm:w-1/2 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105">Check Answer</button>
                <button id="next-level-btn" class="w-full sm:w-1/2 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 hidden">Next Level</button>
                <button id="reset-btn" class="w-full sm:w-1/2 bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-transform transform hover:scale-105">New Verse</button>
            </div>
        </div>

    </div>

    <script>
        // DOM Elements
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const verseInput = document.getElementById('verse-input');
        const startBtn = document.getElementById('start-btn');
        const levelDisplay = document.getElementById('level-display');
        const verseDisplay = document.getElementById('verse-display');
        const checkBtn = document.getElementById('check-btn');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const resetBtn = document.getElementById('reset-btn');
        const messageArea = document.getElementById('message-area');
        const setupMessageArea = document.getElementById('setup-message-area');
        
        // History Elements
        const historyContainer = document.getElementById('history-container');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        // Game State
        let originalVerseText = '';
        let currentLevel = 1;
        const levelPercentages = { 1: 0.25, 2: 0.50, 3: 0.75, 4: 0.90 };
        const HISTORY_KEY = 'verse_memorizer_history';
        const MAX_HISTORY_ITEMS = 5;

        // --- Event Listeners ---
        startBtn.addEventListener('click', startGame);
        resetBtn.addEventListener('click', resetGame);
        checkBtn.addEventListener('click', checkAnswer);
        nextLevelBtn.addEventListener('click', advanceLevel);
        clearHistoryBtn.addEventListener('click', clearHistory);

        // --- Initialization ---
        // Load history immediately when page opens
        renderHistory();

        // --- Game Flow ---

        function startGame() {
            const verseText = verseInput.value.trim();
            
            if (verseText === "") {
                setupMessageArea.textContent = "Please enter a verse to continue.";
                return;
            }
            setupMessageArea.textContent = ""; // Clear message on success
            
            // Save to history before starting
            saveToHistory(verseText);

            originalVerseText = verseText;
            currentLevel = 1;
            setupLevel(currentLevel);
            
            setupScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
        }

        // --- History Functions ---

        function getHistory() {
            const stored = localStorage.getItem(HISTORY_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        function saveToHistory(verse) {
            let history = getHistory();
            
            // Remove the verse if it already exists (to move it to the top)
            history = history.filter(v => v !== verse);
            
            // Add new verse to the beginning
            history.unshift(verse);
            
            // Keep only the most recent items
            if (history.length > MAX_HISTORY_ITEMS) {
                history = history.slice(0, MAX_HISTORY_ITEMS);
            }

            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = getHistory();
            
            if (history.length === 0) {
                historyContainer.classList.add('hidden');
                return;
            }

            historyContainer.classList.remove('hidden');
            historyList.innerHTML = '';

            history.forEach(verse => {
                const btn = document.createElement('button');
                btn.className = 'history-item w-full text-left p-3 rounded bg-slate-50 border border-slate-200 text-slate-600 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700 text-sm truncate';
                
                // Truncate text for display
                const displayText = verse.length > 80 ? verse.substring(0, 80) + '...' : verse;
                btn.textContent = displayText;
                
                btn.onclick = () => {
                    verseInput.value = verse;
                    // Visual feedback
                    verseInput.focus();
                    setupMessageArea.textContent = "Verse loaded from history!";
                    setupMessageArea.className = "mt-4 text-center font-medium h-6 text-green-600";
                    setTimeout(() => {
                        setupMessageArea.textContent = "";
                        setupMessageArea.className = "mt-4 text-center font-medium h-6 text-red-600";
                    }, 2000);
                };
                
                historyList.appendChild(btn);
            });
        }

        function clearHistory() {
            if(confirm('Are you sure you want to clear your recent verses?')) {
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }
        
        function setupLevel(level) {
            // Update level display
            levelDisplay.textContent = `Level ${level} of 4`;
            messageArea.textContent = '';
            
            // Show/hide appropriate buttons
            checkBtn.classList.remove('hidden');
            nextLevelBtn.classList.add('hidden');

            // Get words from the original verse
            const originalVerseArray = originalVerseText.split(/\s+/).filter(word => word.length > 0);
            const wordCount = originalVerseArray.length;
            const percentage = levelPercentages[level];
            const blanksCount = Math.max(1, Math.ceil(wordCount * percentage)); 
            
            // Create a shuffled array of indices to pick from randomly
            const indices = Array.from(Array(wordCount).keys());
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            
            const blankIndices = new Set(indices.slice(0, blanksCount));

            // Populate the display area with words and blanks
            verseDisplay.innerHTML = '';
            originalVerseArray.forEach((word, index) => {
                if (blankIndices.has(index)) {
                    const inputEl = document.createElement('input');
                    inputEl.type = 'text';
                    inputEl.classList.add('blank-input');
                    inputEl.dataset.originalWord = word; 
                    // Auto-focus logic can be added here if needed for desktop
                    verseDisplay.appendChild(inputEl);
                } else {
                    const wordEl = document.createElement('span');
                    wordEl.textContent = word;
                    verseDisplay.appendChild(wordEl);
                }
            });
        }

        function checkAnswer() {
            const inputs = verseDisplay.querySelectorAll('.blank-input');
            let allCorrect = true;

            inputs.forEach(input => {
                const userInput = input.value.trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").toLowerCase();
                const originalWord = input.dataset.originalWord.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").toLowerCase();

                if (userInput === originalWord) {
                    input.classList.add('correct');
                    input.classList.remove('incorrect');
                } else {
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                    allCorrect = false;
                }
            });

            if (allCorrect) {
                handleCorrectAnswer();
            } else {
                messageArea.textContent = "Some answers are incorrect. Keep trying!";
                messageArea.classList.add('text-red-600');
                messageArea.classList.remove('text-green-600');
            }
        }

        function handleCorrectAnswer() {
            messageArea.classList.remove('text-red-600');
            messageArea.classList.add('text-green-600');

            if (currentLevel < 4) {
                messageArea.textContent = `Level ${currentLevel} complete! Click "Next Level" to continue.`;
                checkBtn.classList.add('hidden');
                nextLevelBtn.classList.remove('hidden');
            } else {
                messageArea.textContent = "Congratulations! You've mastered the verse!";
                checkBtn.classList.add('hidden');
                nextLevelBtn.classList.add('hidden');
            }
        }

        function advanceLevel() {
            currentLevel++;
            if (currentLevel <= 4) {
                setupLevel(currentLevel);
            }
        }

        function resetGame() {
            gameScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
            verseInput.value = '';
            originalVerseText = '';
            currentLevel = 1;
            messageArea.textContent = '';
            setupMessageArea.textContent = '';
            
            // Ensure buttons are in the correct state for a new game
            checkBtn.classList.remove('hidden');
            nextLevelBtn.classList.add('hidden');
            
            // Re-render history just in case something changed (though usually updates on start)
            renderHistory();
        }
    </script>
</body>
</html>
